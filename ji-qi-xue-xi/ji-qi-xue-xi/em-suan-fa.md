# EM算法

EM算法是一种迭代算法，用于含有隐变量的概率模型参数的极大似然估计，或极大后验概率估计。EM算法的每次迭代由两步组成：E步：求期望\(Expectation\)；M步求极大\(Maximization\)。

## 算法步骤

输入：观测变量数据 $$Y$$ ，隐变量数据 $$Z$$ ，联合分布 $$P(Y,Z|\theta)$$ ，条件概率分布 $$P(Z|Y,\theta)$$ 

输出：模型参数 $$\theta$$ 

（1）选择参数的初值 $$\theta^{(0)}$$ ，开始迭代

（2）E步：记 $$\theta^{(i)}$$ 为第 $$i$$ 次迭代参数 $$\theta$$ 的估计值，在第 $$i+1$$ 次迭代的E步，计算

                   $$Q(\theta,\theta^{(i)})=E_Z[\log P(Y,Z|\theta)|Y,\theta^{(i)}]=\sum\limits_Z\log P(Y,Z|\theta)P(Z|Y,\theta^{(i)})$$ 

                    这里， $$P(Z|Y,\theta^{(i)})$$ 是在给定观测数据 $$Y$$ 和当前的参数估计 $$\theta^{(i)}$$ 下隐变量数据 $$Z$$ 的条件概

                    率分布。

（3）M步：求使 $$Q(\theta,\theta ^{(i)})$$ 极大化的 $$\theta$$ ，确定第 $$i+1$$ 次迭代的参数的估计值 $$\theta^{(i+1)}$$ 

                    $$\theta^{(i+1)}=\arg\max\limits_\theta Q(\theta,\theta^{(i)})$$ 

（4）重复第（2）步和第（3）步，直至收敛。

### 步骤说明

步骤（1）参数的初值可以任意选择，但需注意EM算法对初值是敏感的

步骤（2）E步求 $$Q(\theta,\theta^{(i)})$$ 。 $$Q$$ 函数式中 $$Z$$ 是未观测数据， $$Y$$ 是观测数据。注意 $$Q(\theta,\theta^{(i)})$$ 的第 $$1$$ 个变元表示要极大化的参数，第 $$2$$ 个变元表示参数的当前估计值。每次迭代实际在求 $$Q$$ 函数及其极大。

步骤（3）M步求 $$Q(\theta,\theta^{(i)})$$ 得极大化，得到 $$\theta^{(i+1)}$$ ，完成一次迭代 $$\theta^{(i)}\to\theta^{(i+1)}$$ ，每次迭代使似然函数增大或达到局部极值。

步骤（4）给出停止迭代的条件，一般是对较小的正数 $$\varepsilon_1,\varepsilon_2$$ ，满足 $$||\theta^{(i+1)}-\theta^{(i)}||<\varepsilon_1$$ 或 $$||Q(\theta^{i+1},\theta^{(i)})-Q(\theta^{i},\theta^{(i)})||<\varepsilon_2$$ 则停止迭代。

### Q函数

E步中的 $$Q(\theta,\theta^{(i)})$$ 是EM算法的核心，称为 $$Q$$ 函数。完全数据的对数似然函数 $$\log P(Y,Z|\theta)$$ 关于在给定观测数据 $$Y$$ 和当前参数 $$\theta^{(i)}$$ 下对未观测数据 $$Z$$ 的条件概率分布 $$P(Z|Y,\theta^{(i)})$$ 的期望称为 $$Q$$ 函数

                    $$Q(\theta,\theta^{(i)})=E_Z[\log P(Y,Z|\theta)|Y,\theta^{(i)}]=\sum\limits_Z\log P(Y,Z|\theta)P(Z|Y,\theta^{(i)})$$ 

## 算法举例

假设有 $$3$$ 枚硬币，分别记作 $$A,B,C$$ 。这些硬币正面出现的概率分别是 $$\pi,p,q$$ 。进行如下掷硬币试验：先掷硬币 $$A$$ ，根据其结果选出硬币 $$B$$ 或硬币 $$C$$ ，正面选硬币 $$B$$ ，反面选 $$C$$ ；然后掷选出的硬币，掷硬币的结果，出现正面记作 $$1$$ ，出现反面记作 $$0$$ ；独立地重复 $$n$$ 次试验（本例 $$n = 10$$ ），结果如下

| n | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 |
| :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| 结果 | 1 | 1 | 0 | 1 | 0 | 0 | 1 | 0 | 1 | 1 |

假设只能观测到掷硬币的结果，不能观测掷硬币的过程。问如何估计三枚硬币正面出现的概率，即三硬币模型的参数。

三硬币模型可以写作： $$P(y|\theta)=\sum\limits_zP(y,z|\theta)=\sum\limits_zP(z|\theta)P(y|z,\theta)$$ 

                                                        $$=\pi p^y(1-p)^{1-y}+(1-\pi)q^y(1-q)^{1-y}$$ 

这里，随机变量 $$y$$ 是观测变量，表示一次试验观测的结果是 $$1$$ 或 $$0$$ ；随机变量 $$z$$ 是隐变量，表示未观测到的掷硬币 $$A$$ 的结果； $$\theta=(\pi,p,q)$$ 是模型参数。这一模型是以上数据的生成模型。注意，随机变量 $$y$$ 的数据可以观测，随机变量 $$z$$ 的数据不可观测。

